---
title: "STAT 331 Project Group I"
author: "Derrick Phan, Steven Ortiz, Jaden Sung, Will Mathewson"
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
editor: source
embed-resources: true
execute: 
  error: true
  echo: true
  message: false
  warning: false
bibliography: references.bib
---

## Datasets

Using the two datasets 'income_per_person_long_series' and 'internet users' we plan to find that the higher a persons income is the more access they can have to technology.

## Cleaning the data

```{r}
# Load in all necessary packages
library(tidyverse)
library(broom)
library(knitr)
library(gganimate)
library(gifski)
```

```{r}
# Read in the csv files
income_original <- read_csv("income_per_person_long_series.csv")
internet_original <- read_csv("internet_users.csv")
```
## Income Cleaning
```{r}
# Function to convert 'k' values (e.g., "1.1k") to numeric
convert_k_to_num <- function(x) {
  x <- as.character(x)
  ifelse(
    str_detect(x, "k"),
    as.numeric(str_remove(x, "k")) * 1000,
    as.numeric(x)
  )
}

# Apply conversion to all columns except 'country'
income_clean <- income_original |>
  mutate(across(-country, 
                convert_k_to_num)) |>
  pivot_longer(-country, 
               names_to = "year", 
               values_to = "income") |>
  mutate(year = as.numeric(year))
```

## Internet Cleaning
```{r}
internet_clean <- internet_original |>
  mutate(across(-country, 
                convert_k_to_num)) |>
  pivot_longer(-country, 
               names_to = "year", 
               values_to = "internet_users") |>
  mutate(year = as.numeric(year))
```

Join the Datasets
```{r}
combined_data <- income_clean |>
  inner_join(internet_clean, 
             by = c("country", "year"))
```

## Written Component
We are examining whether there is a relationship between a country’s GDP per capita and the percentage of its population using the internet. We got the internet data from Gapminder @Gapminder, which gives the proportion of people in each country that have internet access each year since 1960 and we got our income data from World Bank @World_Bank_Open_Data. This data provides the GDP per capita of each country year by year. We hypothesize that countries with higher GDP per capita will also have higher internet usage. We thought that wealthier countries are more likely to have the technological accessibility needed to support widespread internet. We did find outside evidence to support this claim, this author from Pew Reasearch @Author_2014 found that income is a strong predictor of internet use across countries. One thing we had to do to prepare the data for analysis involved converting GDP per capita values into full numeric values. For example, income values like "31.7k" were converted to "31700" to allow for numerical analysis.

## Visualizing the Data (2.1)
```{r}
# Aggregate data: average per country over all years
avg_data <- combined_data |>
  group_by(country) |>
  summarize(avg_income = mean(income, 
                              na.rm = TRUE),
            avg_internet_users = mean(internet_users, 
                                      na.rm = TRUE))

# Plot
ggplot(avg_data, 
       aes(x = avg_income, 
           y = avg_internet_users)) +
  geom_point(alpha = 0.7,
             color = "darkblue", 
             size = 2) +
  scale_x_continuous(labels = scales :: comma) +
  labs(title = "Average Internet Usage vs. GDP per Capita",
       x = "Average GDP per Capita (USD)",
       y = "Average Internet Usage (%)",
       caption = "Data Source: Gapminder & World Bank") +
  theme_minimal()
```

```{r}
#| eval: false

animated_plot <- ggplot(combined_data, 
                        aes(x = income, 
                            y = internet_users)) +
  geom_point(alpha = 0.7, 
             color = "red", 
             size = 2) +
  scale_x_continuous(labels = scales :: comma) +
  scale_y_continuous(labels = scales :: percent_format(scale = 1)) +
  labs(x = "GDP per Capita (USD)",
       y = "Internet Users (%)",
       title = "Internet Usage vs. Income: {frame_time}", 
       subtitle = "Each point is one country in a given year",
       caption = "Data Source: Gapminder & World Bank") +
  theme_minimal() +
  transition_time(year) +
  ease_aes('linear')

# 2) Render as a GIF, saved it to an object to try to fix rendering issues
animated_obj <- animate(animated_plot, 
                        fps = 2, 
                        duration = 10,
                        width = 600, 
                        height = 450,
                        renderer = gifski_renderer())

anim_save("income_vs_internet.gif", 
          animation = animated_obj)
```
![](income_vs_internet.gif)

```{r}
# Plot with regression line (2.2)
ggplot(avg_data, 
       aes(x = avg_income, 
           y = avg_internet_users)) +
  geom_point(color = "darkblue", 
             alpha = 0.7) +
  geom_smooth(method = "lm", 
              se = FALSE, 
              color = "red") +
  scale_x_continuous(labels = scales :: comma) +
  scale_y_continuous(labels = scales :: percent_format(scale = 1)) +
  labs(title = "Linear Regression: Internet Usage vs. GDP per Capita",
       x = "Average GDP per Capita (USD)",
       y = "Average Internet Usage (%)",
       caption = "Data Source: Gapminder & World Bank") +
  theme_minimal()
```

```{r}
# Fit linear regression model
model <- lm(avg_internet_users ~ avg_income, 
            data = avg_data)

# Tidy and display coefficients
tidy(model) |>
  kable(caption = "Linear Regression Coefficients: Internet Usage ~ GDP per Capita")
```

```{r}
# Code for 2.3 (Model Fit)
# Extract vectors
y_vec <- avg_data$avg_internet_users
y_hat_vec <- fitted(model)
resid_vec <- residuals(model)

# Compute variances
var_response <- var(y_vec,
                    na.rm = TRUE)
var_fitted <- var(y_hat_vec,
                  na.rm = TRUE)
var_resid <- var(resid_vec,
                 na.rm = TRUE)

# Compute R^2
R2_by_hand <- var_fitted / var_response

# Table
tbl_variances <- tibble::tibble(
  Statistic = c("Var(Response)\n(A) = Var(avg_internet_users)",
                "Var(Fitted)\n(B) = Var(ˆy)",
                "Var(Residuals)\n = Var(y − ˆy)",
                "R² = B / A"),
  Value = c(var_response,
            var_fitted,
            var_resid,
            R2_by_hand))

tbl_variances |>
  mutate(Value = round(Value, 
                       6)) |>
  kable(caption = "Table: Variances & R² for the Simple Linear Model",
        col.names = c("Quantity", 
                      "Estimate"))
```

